name: Build Rust for Android ARM64

# 手动触发执行
on:
  workflow_dispatch:android-arm64:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true
        components: rustfmt, clippy
    
    - name: Add Android ARM64 target
      run: rustup target add aarch64-linux-android
    
    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r25c
        add-to-path: false
    
    - name: Setup Cargo config for Android
      run: |
        mkdir -p .cargo
        cat > .cargo/config.toml << EOF
        [target.aarch64-linux-androiANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang"
        
        [build]
        target = "aarch64-linux-android"
        EOF
    
    - name: Cache cargo registry
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
    
    - name: Cache target directory
      uses: actions/cache@v3
      with:
        path: target
        key: ${{ runner.os }}-target-android-arm64-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-target-android-arm64-
    
    - name: Build for
        export CC_aarch64_linux_android=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang
        export CXX_aarch64_linux_android=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang++
        export AR_aarch64_linux_android=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/ll_TARGET_AARCH64_LINUX_ANDROID_LINKER=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang
        
        cargo build --release --target aarch64-linux-android
    
    - name: Prepare artifacts
      run: |
        mkdir -p android-arm64-artifacts
        # 复制编译好的二进制文件（根据你的项目名称调整）
        find target/aarch64-linux-android/release -type f -executable -not -name "*.so" -not -name "*.d" | while read file; do
          if [[ -f "$file" && ! "$file" =~ \.(so|d)$ ]]; then
            cp "$file" android-arm64-artifacts/
          fi
        done
        
        # 如果有动态链接库也复制过来
        find target/aarch64-linux-android/release -name "*.so" | while read file; do
          cp "$file" android-arm64-artifacts/
        done
        
        # 创建构建信息文件
        echo "Build Date: $(date)" > android-arm64-artifacts/build_info.txt
        echo "Target: aarch64-linux-android (Android ARM64 v8a)" >> android-arm64-artifacts/build_info.txt
        echo "Commit: $GITHUB_SHA" >> android-arm64-artifacts/build_info.txt
        
        # 显示编译输出内容
        ls -la android-arm64-artifacts/
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: rust-android-arm64-v8a
        path: android-arm64-artifacts/
        retention-days: 30
